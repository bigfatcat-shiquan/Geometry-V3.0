<!DOCTYPE html>
<html lang="zh-cmn-Hans" xmlns:th="http://www.thymeleaf.org">
	<div th:replace="./base :: geometry3_public_resource"></div>
	<head>
		<link rel="stylesheet" type="text/css" href="../static/css/problem_detail.css"/>
		<meta charset="utf-8"/>
		<title>Geometry3-é¢˜ç›®è¯¦æƒ…</title>
	</head>
	<body>
		<div class="all_container">
			<!-- å…¬å…±-é¡µé¢å‰ç½®éƒ¨åˆ† -->
			<div th:replace="./base :: geometry3_public_nav"></div>
			<!-- æ­£æ–‡éƒ¨åˆ† -->
			<div id="problem_detail">
				<!-- é¢˜ç›®è¯¦æƒ…å±•ç¤º -->
				<div id="problem_show">
					<div id="problem_show_guide" class="step_guide">
						<img class="guide_icon" src="../static/img/icons/no_1.png" alt="ä¸€ï¼Œé¢˜ç›®è¯¦æƒ…å±•ç¤º"/>
						<span>é¢˜ç›®è¯¦æƒ…ä¿¡æ¯</span>
					</div>
					<div id="problem_show_picture">
						<div th:text="'é¢˜ç›®åç§°ï¼š ' + ${info.the_problem.problem_name}"></div>
						<img th:src="${info.the_problem.problem_picture}" src="" alt="é¢˜ç›®å›¾ç‰‡"/>
					</div>
					<div id="problem_show_known_conditions">
						<div style="font-weight: bold">å·²çŸ¥æ¡ä»¶ï¼š</div>
						<ul id="known_conditions_list">
							<li th:each="equal_str :${info.the_problem.initial_equals_str_set}"
								th:text="${equal_str}" style="margin-top: 5px"></li>
						</ul>
					</div>
					<div id="problem_show_need_prove">
						<div style="font-weight: bold">æ±‚è¯ï¼š</div>
						<div id="need_prove_content" th:text="${info.the_problem.need_prove_equal_str}"></div>
					</div>
				</div>
				<!-- è§£ç­”æ—¥å¿—å±•ç¤º -->
				<div id="problem_solve_log">
					<div id="problem_solve_log_guide" class="step_guide">
						<img class="guide_icon" src="../static/img/icons/no_3.png" alt="ä¸‰ï¼Œé¢˜ç›®è§£ç­”æ—¥å¿—"/>
						<span>é¢˜ç›®è§£ç­”æ—¥å¿—</span>
					</div>
					<div id="problem_solve_log_box">
						<div id="problem_solve_log_setting">
							<div id="problem_solve_log_setting_detail" class="switchbutton_setting_1"
								 data-switch='{"onText":"ç®€ç‰ˆ", "offText":"è¯¦ç‰ˆ", "checked":true}'></div>
						</div>
						<div id="problem_solve_log_content">
							<table id="problem_solve_log_table">
								<thead>
									<tr>
										<th style="width:8%"></th>
										<th style="width:92%"></th>
									</tr>
								</thead>
								<tbody>
									<tr><td>âˆµ</td><td>AB+BC=AC, AB+BC=BD</td></tr>
									<tr><td>âˆ´</td><td>AC=BD</td></tr>
									<tr><td>âˆµ</td><td>âˆ ABC+âˆ BDE=âˆ ADC, âˆ ABC+âˆ BDE=âˆ AMC</td></tr>
									<tr><td>âˆ´</td><td>âˆ ADC=âˆ AMC</td></tr>
									<tr><td>âˆµ</td><td>AB=DE, BC=EF, âˆ ABC=âˆ DEF</td></tr>
									<tr><td>âˆ´</td><td>ğŸ”ºABCâ‰ŒğŸ”ºDEF</td></tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<!-- é¢˜ç›®è§£ç­” -->
				<div id="problem_solve">
					<div id="problem_solve_guide" class="step_guide">
						<img class="guide_icon" src="../static/img/icons/no_2.png" alt="äºŒï¼Œè¿›è¡Œé¢˜ç›®è§£ç­”"/>
						<span>ç‚¹å‡»è‡ªåŠ¨æ¨ç†è§£ç­”é¢˜ç›®</span>
					</div>
					<div id="problem_solve_start_button">
						<img src="../static/img/buttons/start_solve.png" alt="å¯åŠ¨é¢˜ç›®æ¨ç†ç¨‹åº"/>
					</div>
					<div id="problem_solve_setting">
						<div id="problem_solve_setting_title">
							<span>é«˜çº§è®¾ç½®</span>
						</div>
						<div id="problem_solve_setting_deduce_times" class="problem_solve_setting_option">
							<span>æŒ‡å®šæœ€å¤§æ¨å¯¼æ¬¡æ•°</span>
							<input id="input_deduce_times" type="text" placeholder="é»˜è®¤"/>
						</div>
						<div id="problem_solve_setting_max_complex" class="problem_solve_setting_option">
							<span>æŒ‡å®šå¤šé¡¹å¼æœ€å¤§é•¿åº¦</span>
							<input id="input_max_complex" type="text" placeholder="é»˜è®¤"/>
						</div>
					</div>
				</div>
			</div>
			<!-- å…¬å…±-é¡µè„šéƒ¨åˆ† -->
			<div th:replace="./base :: geometry3_public_footer"></div>
		</div>
		<script th:inline="javascript">

			// åˆå§‹åŒ–å…¨å±€å˜é‡
			var on_deducing = false;
			var deduce_finished = false;
			var problem_solve_response = null;

			// è§¦å‘å™¨
			$(document).ready(function() {

				// æ–‡æ¡£åŠ è½½å®Œæ¯•åè§£æé¢˜ç›®è¯¦ç»†ä¿¡æ¯
				var problem_name = [[${info.the_problem.problem_name}]];
				var points_set = [[${info.the_problem.initial_points_set}]];
				var points_location_x = [[${info.the_problem.points_location_x}]];
				var points_location_y = [[${info.the_problem.points_location_y}]];
				var initial_equals_str_set = [[${info.the_problem.initial_equals_str_set}]];
				var need_prove_equal_str = [[${info.the_problem.need_prove_equal_str}]];
				var max_deduce_times;
				var max_complex_len;

				// æäº¤é¢˜ç›®è‡³åå°è¿›è¡Œè§£ç­”ï¼Œå¾—åˆ°é¢˜ç›®è§£ç­”æ—¥å¿—
				$("#problem_solve_start_button").on("click", function() {
					// æ•´ç†é¢˜ç›®ä¿¡æ¯åŠå‚æ•°ä¿¡æ¯
					try {
						max_deduce_times = parseInt($("#input_deduce_times").val());
						if (isNaN(max_deduce_times) || max_deduce_times < 0) {
							max_deduce_times = 0;
						}
					}
					catch(err) {
						max_deduce_times = 0;
					}
					try {
						max_complex_len = parseInt($("#input_max_complex").val());
						if (isNaN(max_complex_len) || max_complex_len < 0) {
							max_complex_len = 0;
						}
					}
					catch(err) {
						max_complex_len = 0;
					}
					var data_object = {
						"problem_name": problem_name,
						"points_set": JSON.stringify(points_set),
						"points_location_x": JSON.stringify(points_location_x),
						"points_location_y": JSON.stringify(points_location_y),
						"initial_equals_str_set": JSON.stringify(initial_equals_str_set),
						"need_prove_equal_str": need_prove_equal_str,
						"max_deduce_times": max_deduce_times,
						"max_complex_len": max_complex_len
					};
					alert(JSON.stringify(data_object));
					// å¼‚æ­¥è¯·æ±‚è§£ç­”é¢˜ç›®æœåŠ¡
					$.ajax({
					    url: "/solveProblem",
					    type: "POST",
					    data: JSON.stringify(data_object),
					    contentType: "application/json",
						dataType: "text",
					    success: function(data) {
					        on_deducing = false;
					        deduce_finished = true;
							problem_solve_response = data;
							changeLogContent(on_deducing, deduce_finished, problem_solve_response);
					    },
					    beforeSend: function() {
					        on_deducing = true;
					        deduce_finished = false;
							problem_solve_response = null;
							changeLogContent(on_deducing, deduce_finished, null);
					    },
					    error: function () {
					        on_deducing = false;
					        $.messager.alert('é”™è¯¯', 'åå°è§£é¢˜è¿‡ç¨‹å‡ºç°æ•…éšœ');
							changeLogContent(on_deducing, deduce_finished, null);
					    }
					});
				});

				// æ›´æ–°é¢˜ç›®è§£ç­”æ—¥å¿—çŠ¶æ€
				var changeLogContent = function(on_deducing, deduce_finished, data) {
					// è·å–æ—¥å¿—è¡¨æ ¼å†…å®¹ä¸»ä½“
					var table_body = $("#problem_solve_log_table tbody");
					// æ ¹æ®å½“å‰çŠ¶æ€é‡‡å–ä¸åŒæ›´æ–°æªæ–½
					if (!on_deducing && deduce_finished) {
						// æ¨å¯¼æˆåŠŸå®Œæˆ
						var problem_solve_log = JSON.parse(data)['problem_solve_log'];
						var problem_solve_log_complexity = problem_solve_log['complexity'];
						var problem_solve_log_because = problem_solve_log['because'];
						var problem_solve_log_so = problem_solve_log['so'];
						alert(JSON.parse(data)['has_proved']);
						// æ¸…ç©ºåŸæœ‰æ—¥å¿—
						table_body.empty();
						// å†™å…¥æ—¥å¿—å†…å®¹
						let is_simplified_version = $("#problem_solve_log_setting_detail").data('switch').checked;
						for (var i=0; i<problem_solve_log_complexity.length; i++) {
							// ç®€ç‰ˆæ—¥å¿—ä¸‹è¿‡æ»¤æ‰ç»†èŠ‚å†…å®¹
							if (is_simplified_version && problem_solve_log_complexity[i] === "detailed") continue;
							table_body.append(
									"<tr><td>âˆµ</td><td>" + problem_solve_log_because[i] + "</td></tr>");
							table_body.append(
									"<tr><td>âˆµ</td><td>" + problem_solve_log_so[i] + "</td></tr>");
						}
					} else if (on_deducing && !deduce_finished) {
						// æ­£åœ¨æ¨å¯¼ä¸­
						table_body.empty();
					} else if (!on_deducing && !deduce_finished) {
						// æœªè¿›è¡Œæ¨å¯¼æˆ–æ¨å¯¼å¤±è´¥
						table_body.empty();
					}
				}

				// åˆ‡æ¢æ—¥å¿—ç®€ç‰ˆ/è¯¦ç‰ˆæ•ˆæœ
				$("#problem_solve_log_setting_detail").on("click", function() {
					setTimeout(1000);
					if (!on_deducing && deduce_finished) {
						changeLogContent(on_deducing, deduce_finished, problem_solve_response);
					}
				});

			});

		</script>
	</body>
</html>